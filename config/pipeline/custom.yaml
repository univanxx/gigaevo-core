# @package _global_

# Explicit Hydra config version of the DefaultPipeline
# Analogous to DefaultPipelineBuilder but entirely declarative

evolution_context:
  _target_: gigaevo.entrypoint.evolution_context.EvolutionContext
  problem_ctx: ${problem_context}
  llm_wrapper: ${ref:llm}
  storage: ${ref:redis_storage}

dag_blueprint:
  _target_: gigaevo.runner.dag_blueprint.DAGBlueprint
  _convert_: all
  # Stage definitions
  nodes:
    # Validation stage (checks syntax and security)
    ValidateCodeStage:
      _target_: gigaevo.programs.stages.validation.ValidateCodeStage
      _partial_: true
      max_code_length: ${max_code_length}
      timeout: ${stage_timeout}
      safe_mode: true

    # Execution stages (runs the program)
    CallProgramFunction:
      _target_: gigaevo.programs.stages.python_executors.execution.CallProgramFunction
      _partial_: true
      function_name: entrypoint
      python_path:
        - ${problem.dir}
      timeout: ${stage_timeout}

    # Validation stage (evaluates the output)
    CallValidatorFunction:
      _target_: gigaevo.programs.stages.python_executors.execution.CallValidatorFunction
      _partial_: true
      path: ${problem.dir}/validate.py
      function_name: validate
      timeout: ${stage_timeout}

    # Complexity analysis (measures the length of the code)
    ComputeComplexityStage:
      _target_: gigaevo.programs.stages.complexity.ComputeComplexityStage
      _partial_: true
      timeout: ${stage_timeout}

    # Merge validator and complexity metrics (dict[str, float]) into a single dictionary
    MergeMetricsStage:
      _target_: gigaevo.programs.stages.json_processing.MergeStrFloatDict
      _partial_: true
      timeout: ${stage_timeout}

    # Ensure all required metrics exist (e.g. is_valid, fitness)
    EnsureMetricsStage:
      _target_: gigaevo.programs.stages.metrics.EnsureMetricsStage
      _partial_: true
      metrics_factory: ${ref:metrics_context::get_sentinels}
      metrics_context: ${metrics_context}
      timeout: ${stage_timeout}

    # Insights generation (uses LLM to generate insights)
    InsightsStage:
      _target_: gigaevo.programs.stages.insights.InsightsStage
      _partial_: true
      llm: ${ref:llm}
      task_description: ${ref:problem_context::task_description}
      metrics_context: ${metrics_context}
      max_insights: ${max_insights}
      timeout: ${stage_timeout}

    # Lineage tracking - descendants (tracks the descendants of the program)
    DescendantProgramIds:
      _target_: gigaevo.programs.stages.collector.DescendantProgramIds
      _partial_: true
      storage: ${ref:redis_storage}
      selector:
        _target_: gigaevo.programs.stages.ancestry_selector.AncestrySelector
        metrics_context: ${metrics_context}
        strategy: best_fitness
        max_selected: 1
      timeout: ${stage_timeout}

    # Lineage tracking - ancestors (tracks the ancestors of the program)
    AncestorProgramIds:
      _target_: gigaevo.programs.stages.collector.AncestorProgramIds
      _partial_: true
      storage: ${ref:redis_storage}
      selector:
        _target_: gigaevo.programs.stages.ancestry_selector.AncestrySelector
        metrics_context: ${metrics_context}
        strategy: best_fitness
        max_selected: 2
      timeout: ${stage_timeout}

    # Lineage analysis (uses LLM to generate insights about the lineage)
    LineageStage:
      _target_: gigaevo.programs.stages.insights_lineage.LineageStage
      _partial_: true
      llm: ${ref:llm}
      task_description: ${ref:problem_context::task_description}
      metrics_context: ${metrics_context}
      storage: ${ref:redis_storage}
      timeout: ${stage_timeout}

    # Lineage tracking - descendants (aggregates the lineage of the descendants)
    LineagesToDescendants:
      _target_: gigaevo.programs.stages.insights_lineage.LineagesToDescendants
      _partial_: true
      storage: ${ref:redis_storage}
      source_stage_name: LineageStage
      timeout: ${stage_timeout}

    # Lineage tracking - ancestors (aggregates the lineage of the ancestors)
    LineagesFromAncestors:
      _target_: gigaevo.programs.stages.insights_lineage.LineagesFromAncestors
      _partial_: true
      storage: ${ref:redis_storage}
      source_stage_name: LineageStage
      timeout: ${stage_timeout}

    # Mutation context assembly (aggregates the metrics, insights, and lineage) into a single context
    MutationContextStage:
      _target_: gigaevo.programs.stages.mutation_context.MutationContextStage
      _partial_: true
      metrics_context: ${metrics_context}
      timeout: ${stage_timeout}

  # Data flow edges (source -> destination with input name) (defines how the data flows between the stages)
  data_flow_edges:
    # Main execution flow
    - source_stage: CallProgramFunction
      destination_stage: CallValidatorFunction
      input_name: payload

    # Metrics merging
    - source_stage: CallValidatorFunction
      destination_stage: MergeMetricsStage
      input_name: first

    - source_stage: ComputeComplexityStage
      destination_stage: MergeMetricsStage
      input_name: second

    - source_stage: MergeMetricsStage
      destination_stage: EnsureMetricsStage
      input_name: candidate

    # Mutation context inputs
    - source_stage: EnsureMetricsStage
      destination_stage: MutationContextStage
      input_name: metrics

    - source_stage: InsightsStage
      destination_stage: MutationContextStage
      input_name: insights

    # Lineage data flow
    - source_stage: DescendantProgramIds
      destination_stage: LineagesToDescendants
      input_name: descendant_ids

    - source_stage: AncestorProgramIds
      destination_stage: LineagesFromAncestors
      input_name: ancestor_ids

    - source_stage: LineagesToDescendants
      destination_stage: MutationContextStage
      input_name: lineage_descendants

    - source_stage: LineagesFromAncestors
      destination_stage: MutationContextStage
      input_name: lineage_ancestors

  # Execution order dependencies
  exec_order_deps:
    CallProgramFunction:
      - _target_: gigaevo.programs.dag.automata.ExecutionOrderDependency
        stage_name: ValidateCodeStage
        condition: success

    InsightsStage:
      - _target_: gigaevo.programs.dag.automata.ExecutionOrderDependency
        stage_name: EnsureMetricsStage
        condition: always

    LineageStage:
      - _target_: gigaevo.programs.dag.automata.ExecutionOrderDependency
        stage_name: EnsureMetricsStage
        condition: always

    LineagesToDescendants:
      - _target_: gigaevo.programs.dag.automata.ExecutionOrderDependency
        stage_name: LineageStage
        condition: always

    LineagesFromAncestors:
      - _target_: gigaevo.programs.dag.automata.ExecutionOrderDependency
        stage_name: LineageStage
        condition: always

  # DAG-level settings
  max_parallel_stages: ${dag_concurrency}
  dag_timeout: ${dag_timeout}
